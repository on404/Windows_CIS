$l2hklm =@{

    "hklm\system\currentcontrolset\control\print\providers\lanman print services\servers"= @{
        "addprinterdrivers"= 1
        }

    "hklm\software\policies\microsoft\cryptography"= @{
        "forcekeyprotection"= 2
        }

    "hklm\system\currentcontrolset\services\btagservice"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\bthserv"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\mapsbroker"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\gameinputsvc"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\lfsvc"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\lltdsvc"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\msiscsi"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\spooler"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\wercplsupport"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\rasauto"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\sessionenv"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\termservice"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\umrdpservice"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\remoteregistry"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\lanmanserver"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\snmp"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\wersvc"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\wecsvc"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\wpnservice"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\pushtoinstall"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\winrm"= @{
        "start"= 4
        }

    "hklm\system\currentcontrolset\services\winhttpautoproxysvc"= @{
        "start"= 4
        }

    "hklm\software\microsoft\windows\currentversion\policies\explorer"= @{
        "allowonlinetips"= 0
        "noonlineprintswizard"= 1
        "nopublishingwizard"= 1
        }

    "hklm\system\currentcontrolset\services\rasman\parameters"= @{
        "disablesavepassword"= 1
        }

    "hklm\system\currentcontrolset\services\tcpip\parameters"= @{
        "keepalivetime"= 300000
        "performrouterdiscovery"= 0
        "tcpmaxdataretransmiss ions"= 3
        }

    "hklm\system\currentcontrolset\services\tcpip6\parameters"= @{
        "tcpmaxdataretransmis sions"= 3 
        "disabledcomponents"= 255
        }

    "hklm\software\policies\microsoft\windows nt\dnsclient"= @{
        "disableipv6defaultdnsservers"= 1
        }

    "hklm\software\policies\microsoft\windows\system"= @{
        "enablefontproviders"= 0
        "allowcrossdeviceclipboard"= 0
        "uploaduseractivities"= 0
        }

    "hklm\software\policies\microsoft\windows\lltd"= @{
        "allowlltdioondomain"= 0
        "allowlltdioonpublicnet"= 0
        "enablelltdio"= 0
        "prohibitlltdioonprivatenet"= 0
        "allowrspndrondomain"= 0
        "allowrspndronpublicnet"= 0
        "enablerspndr"= 0
        "prohibitrspndronprivatenet"= 0
        }

    "hklm\software\policies\microsoft\peernet"= @{
        "disabled"= 1
        }

    "hklm\software\policies\microsoft\windows\wcn\registrars"= @{
        "enableregistrars"= 0
        "disableupnpregistrar"= 0
        "disableinband802dot11registrar"= 0
        "disableflashconfigregistrar"= 0
        "disablewpdregistrar"= 0
        }

    "hklm\software\policies\microsoft\windows\wcn\ui"= @{
        "disablewcnui"= 1
        }

    "hklm\software\policies\microsoft\windows nt\printers\wpp"= @{
        "windowsprotectedprintgrouppolicystate"= 1
        }

    "hklm\software\policies\microsoft\windows\currentversion\pushnotifications"= @{
        "nocloudapplicationnotification"= 1
        }

    "hklm\software\policies\microsoft\windows\explorer"= @{
        "hiderecommendedpersonalizedsites"= 1
        "nousestoreopenwith"= 1
        "disablegraphrecentitems"= 1
        }

    "hklm\software\policies\microsoft\windows\tabletpc"= @{
        "preventhandwritingdatasharing"= 1
        }

    "hklm\software\policies\microsoft\windows\handwritingerrorreports"= @{
        "preventhandwritingerrorreports"= 1
        }

    "hklm\software\policies\microsoft\windows\internet connection wizard"= @{
        "exitonmsicw"= 1
        }

    "hklm\software\policies\microsoft\windows nt\printers"= @{
        "disablehttpprinting"= 1
        }

    "hklm\software\policies\microsoft\windows\registration wizard control"= @{
        "noregistration"= 1
        }

    "hklm\software\policies\microsoft\searchcompanion"= @{
        "disablecontentfileupdates"= 1
        }

    "hklm\software\policies\microsoft\messenger\client"= @{
        "ceip"= 2
        }

    "hklm\software\policies\microsoft\sqmclient\windows"= @{
        "ceipenable"= 0
        }

    "hklm\software\policies\microsoft\windows\windows error reporting"= @{
        "disabled" = 1
        "doreport"= 0
        }

    "hklm\software\microsoft\windows\currentversion\policies\system\kerberos\param eters"= @{
        "devicepkinitbehavior"= 0
        "devicepkinitenabled"= 1
        }

    "hklm\software\policies\microsoft\control panel\international"= @{
        "blockuserinputmethodsforsignin"= 1
        }

    "hklm\software\policies\microsoft\windows\scripteddiagnosticsprovider\policy"= @{
        "disablequeryremoteserver"= 0
        }

    "hklm\software\policies\microsoft\windows\wdi\{9c5a40da-b965-4fc3-8781-88dd50a6299d}"= @{
        "scenarioexecutionenabled"= 0
        }

    "hklm\software\policies\microsoft\windows\advertisinginfo"= @{
        "disabledbygrouppolicy"= 1
        }

    "hklm\software\policies\microsoft\windows\appcompat"= @{
        "disableapisamping" = 1
        "disableapplicationfootprint"= 1
        "disableinstalltracing"= 1
        }

    "hklm\software\policies\microsoft\windows\currentversion\appmodel\statemanager"= @{
        "allowsharedlocalappdata"= 0
        }

    "hklm\software\microsoft\windows\currentversion\policies\system"= @{
        "blockhostedappaccesswinrt"= 1
        }

    "hklm\software\policies\microsoft\camera"= @{
        "allowcamera"= 0
        }

    "hklm\software\policies\microsoft\windows\cloudcontent"= @{
        "disablecloudoptimizedcontent"= 1
        }

    "hklm\software\policies\microsoft\windows\datacollection"= @{
        "disableenterpriseauthproxy"= 1
        }

    "hklm\software\policies\microsoft\windows\appinstaller"= @{
        "enableappinstaller"= 0
        "enablewindowspackagemanagercommandlineinterfaces"= 0
        }

    "hklm\software\policies\microsoft\windows\locationandsensors"= @{
        "disablelocation"= 1
        }

    "hklm\software\policies\microsoft\windows\messaging"= @{
        "allowmessagesync"= 0
        }

    "hklm\software\policies\microsoft\windows defender\spynet"= @{
        "spynetreporting"= 0
        }

    "hklm\software\policies\microsoft\windows defender\nis"= @{
        "enableconvertwarntoblock"= 1
        }

    "hklm\software\policies\microsoft\windows defender\remediation\behavioral network blocks\brute force protection"= @{
        "bruteforceprotectionaggressiveness"= 2
        }

    "hklm\software\policies\microsoft\windows defender\remediation\behavioral network blocks\remote encryption protection"= @{
        "remoteencryptionprotectionaggressiveness"= 2
        }

    "hklm\software\policies\microsoft\windows defender\reporting"= @{
        "disablegenericreports"= 1
        }

    "hklm\software\policies\microsoft\windows\windows feeds"= @{
        "enablefeeds"= 0
        }

    "hklm\software\policies\microsoft\pushtoinstall"= @{
        "disablepushtoinstall"= 1
        }

    "hklm\software\policies\microsoft\windows nt\terminal services\client"= @{
        "disablecloudclipboardintegration"= 1
        }

    "hklm\software\policies\microsoft\windows nt\terminal services"= @{
        "fdenytsconnections"= 1
        "enableuiaredirection"= 0
        "fdisableccm"= 1
        "fdisablelocationredir"= 1
        "fdisablelpt"= 1
        "fdisablepnpredir"= 1
        "fdisablewebauthn"= 1
        "sccliplevel"= 0
        "maxidletime"= 900000
        "maxdisconnectiontime"= 60000
        }

    "hklm\software\policies\microsoft\windows\windows search"= @{
        "allowcloudsearch"= 0
        }

    "hklm\software\policies\microsoft\windows\windows search"= @{
        "enabledynamiccontentinwsb"= 0
        }

    "hklm\software\policies\microsoft\windows nt\currentversion\software protection platform"= @{
        "nogenticket"= 1
        }

    "hklm\software\policies\microsoft\windowsstore"= @{
        "disablestoreapps"= 1
        "removewindowsstore"= 1
        }

    "hklm\software\policies\microsoft\windowsinkworkspace"= @{
        "allowsuggestedappsinwindowsinkworkspace"= 0
        }

    "hklm\software\policies\microsoft\windows\installer"= @{
        "safeforscripting"= 0
        }

    "hklm\software\policies\microsoft\windows\powershell\scriptblocklogging"= @{
        "enablescriptblocklogging"= 1
        }

    "hklm\software\policies\microsoft\windows\powershell\transcription"= @{
        "enabletranscripting"= 1
        }

    "hklm\software\policies\microsoft\windows\winrm\service"= @{
        "allowautoconfig"= 0
        }

    "hklm\software\policies\microsoft\windows\winrm\service\winrs"= @{
        "allowremoteshellaccess"= 0
        }

    "hklm\software\policies\microsoft\windows\sandbox"= @{
        "allowwritetomappedfolders"= 0
        }
}

$l2hku= @{
    "hku\[user sid]\software\policies\microsoft\assistance\client\1.0"= @{
        "NoImplicitFeedback"= 1
        }

    "hku\[user sid]\software\policies\microsoft\windows\cloudcontent"= @{
        "disabletailoredexperienceswithdiagnosticdata"= 1
        "disablewindowsspotlightfeatures"= 1
        }

    "hku\[user sid]\software\policies\microsoft\windowsmediaplayer"= @{
        "preventcodecdownload"= 1
        }
}

function Set-RegistryKeys {
    param (
        [Parameter(Mandatory=$true)]
        [hashtable]$table
    )
    foreach ($key in $table.Keys) {
        try {
            # Convert HKLM to full path
            $fullPath = $key -replace '(?i)^hklm\\', 'HKLM:\\'
            
            if (!(Test-Path $fullPath)) {
                New-Item -Path $fullPath -Force | Out-Null
            }
            $values = $table[$key]
            foreach ($valueName in $values.Keys) {
                $value = $values[$valueName]
                $type = if ($value -is [int]) { "DWord" } else { "String" }
                
                # Use New-ItemProperty instead of Set-ItemProperty
                if (Get-ItemProperty -Path $fullPath -Name $valueName -ErrorAction SilentlyContinue) {
                    Set-ItemProperty -Path $fullPath -Name $valueName -Value $value
                } else {
                    New-ItemProperty -Path $fullPath -Name $valueName -Value $value -PropertyType $type -Force | Out-Null
                }
            }
        }
        catch {
            Write-Error "Failed to process key '$fullPath': $_"
        }
    }
}
function Set-UserRegistryKeys {
    param (
        [Parameter(Mandatory=$true)]
        [hashtable]$Table
    )

    # Get all user SIDs from HKEY_USERS except system SIDs
    $userSIDs = Get-ChildItem -Path "Registry::HKEY_USERS" | Where-Object {
        $_.PSChildName -notmatch '^(S-1-5-18|S-1-5-19|S-1-5-20|\.DEFAULT)$'
    }

    foreach ($sid in $userSIDs) {
        foreach ($key in $Table.Keys) {
            # Replace the placeholder [USER SID] with the actual user SID
            $userKey = $key -replace '\[USER SID\]', $sid.PSChildName
            $userKey = "Registry::$userKey"  # Ensure we're using the Registry provider

            if (!(Test-Path $userKey)) {
                try {
                    New-Item -Path $userKey -Force | Out-Null
                }
                catch {
                    Write-Error "Failed to create registry key '$userKey': $_"
                    continue
                }
            }

            $values = $Table[$key]
            foreach ($valueName in $values.Keys) {
                $value = $values[$valueName]
                try {
                    $type = if ($value -is [int]) { "DWord" } else { "String" }
                    Set-ItemProperty -Path $userKey -Name $valueName -Value $value -Type $type
                }
                catch {
                    Write-Error "Failed to set value '$valueName' in key '$userKey': $_"
                }
            }
        }
    }
}
Set-RegistryKeys -Table $l2hklm
Set-UserRegistryKeys -Table $l2hku
Write-Host "All Local and User registry settings for level 2 has been applied"